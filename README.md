# Сервис Аутентификации

Это сервис аутентификации на Go, который предоставляет эндпоинты для работы с JWT-токенами: генерация, обновление и управление токенами. Используется роутер Chi и Swagger для документации API.

--- 
#### Предисловие:
-  Хочу обратить внимание, что в config.yaml и docker-config.yaml указан:
   ``webhook: url:`` "https://webhook.site/673e03a4-b1bb-4546-88fa-9a521c61a1d0".
   Это url, на который приходит сообщение/ивент, что произошел вход с другого ip.
- Уникальный URL-адрес для тестирования отправкии сообщения/ивента был сгенерирован на [webhook.site](https://webhook.site/). Чтобы протестировать отправку по другому URL-адресу, вам необходимо указать свой URL в файлах конфигурации.
- ``NotifyWebhook`` - функция для отправки тестового сообщения на заданный URL-адрес описана в пакете /internal/notifier.
- Так же для тестирования отправки сообщения, во время входа с другого устройства, можете ``вручную изменить сохраненный ip в базе данных для refresh-токена``, а после выполнить:
   ```bash
   curl -X POST "http://localhost:8090/api-auth/refresh-token" -H "Authorization: Bearer <access_token>" -H "Content-Type: application/json" -d '{"refresh_token": "<refresh_token>"}'
   ```
  После чего произойдет отправка webhook'а.
- Для просмотра логов о том, что, например, "обновление токена запрещено. User-Agent был изменен" или "обнаружен вход с нового устройства, отправка webhook", открывайте ``auth_service`` в Docker.
---

## Содержание
- [Возможности](#возможности)
- [Требования](#требования)
- [Установка](#установка)
- [Запуск приложения](#запуск-приложения)
- [Эндпоинты API](#эндпоинты-api)
- [Конфигурация](#конфигурация)
- [Swagger-документация](#swagger-документация)

## Возможности
- Генерация пары access/refresh JWT-токенов.
- Получение GUID (UUID) пользователя по access-токену.
- Обновление токенов с проверкой IP и User-Agent.
- Выход из аккаунта с аннулированием refresh-токена.
- Интерактивная Swagger-документация для работы с API.

## Требования
- **Go**: Версия 1.24.
- **Docker**: Для запуска в контейнерах.
- **Docker Compose**: Для запуска приложения и базы данных с помощью `docker-compose`.
- База данных, совместимая с репозиторием JWT (настраивается в `config.yaml` или `config-docker.yaml`).

## Установка
1. Клонируйте репозиторий:


2. Установите зависимости:
   ```bash
   go mod tidy
   ```

3. Настройте конфигурационные файлы (`config.yaml` или `config-docker.yaml`) с параметрами базы данных и секретным ключом JWT.

## Запуск приложения
Для локального запуска:
```bash
go run main.go
```

Приложение запустится по адресу `http://localhost:8090` (если не указано иное в `config.yaml`).

Для запуска в Docker:
1. Настройте `config-docker.yaml`.

Для запуска приложения и базы данных с помощью Docker Compose, в Docker перейдите в директорию проекта и выполните:
```bash
docker-compose -f docker-compose.yml up -d
```

Это создаст и запустит контейнеры для приложения и базы данных в фоновом режиме.

## Эндпоинты API
Сервис предоставляет следующие эндпоинты под базовым путем `/api-auth`:

| Метод | Эндпоинт             | Описание                                     | Требуется аутентификация |
|-------|----------------------|----------------------------------------------|--------------------------|
| GET   | `/get-tokens`        | Генерирует новую пару access/refresh токенов | Нет                      |
| GET   | `/me`                | Возвращает GUID пользователя по access-токену | Да                      |
| POST  | `/refresh-token`     | Обновляет токены по refresh-токену           | Да                       |
| POST  | `/logout`            | Аннулирует refresh-токен и завершает сеанс   | Да                       |

### Примеры запросов
1. **Генерация токенов**:
   ```bash
   curl -X GET "http://localhost:8090/api-auth/get-tokens?guid=123e4567-e89b-12d3-a456-426614174000"
   ```
   Ответ:
   ```json
   {
     "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
     "refresh_token": "vcSi0369y1I62wOpxZFpgZ..."
   }
   ```

2. **Получение GUID пользователя**:
   ```bash
   curl -X GET "http://localhost:8090/api-auth/me" -H "Authorization: Bearer <access_token>"
   ```
   Ответ:
   ```json
   {
     "user_guid": "123e4567-e89b-12d3-a456-426614174000"
   }
   ```

3. **Обновление токенов**:
   ```bash
   curl -X POST "http://localhost:8090/api-auth/refresh-token" -H "Authorization: Bearer <access_token>" -H "Content-Type: application/json" -d '{"refresh_token": "<refresh_token>"}'
   ```
   Ответ:
   ```json
   {
     "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
     "refresh_token": "vcSi0369y1I62wOpxZFpgZ..."
   }
   ```

4. **Выход из аккаунта**:
   ```bash
   curl -X POST "http://localhost:8090/api-auth/logout" -H "Authorization: Bearer <access_token>"
   ```
   Ответ:
   ```json
   {
     "message": "выполнен выход из аккаунта"
   }
   ```

## Конфигурация
Приложение использует два конфигурационных файла:
- **`config.yaml`**: Для локального запуска.
- **`config-docker.yaml`**: Для запуска в Docker.

Необходимые параметры:
- **JWT Secret Key**: Для подписи и проверки JWT-токенов.
- **Настройки базы данных**: Параметры подключения к репозиторию для JWT.

## Swagger-документация
Документация API доступна через Swagger UI по адресу:
```
http://localhost:8090/swagger/index.html#
```

Это интерактивный интерфейс для тестирования и изучения эндпоинтов API.